name: Copytrade CI/CD Pipeline

on: 
  push:
    branches:
      - main
    paths:
      - 'conf.d/copytrade.conf'
      - 'nginx.conf'
      - 'docker-compose.yml'
      - 'deploy-copytrade.sh'
      - '.github/workflows/copytrade.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy Copytrade Nginx
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT }}
        script: |
          # Создаём директорию если её нет
          mkdir -p /opt/polycopy/nginx
          cd /opt/polycopy/nginx
          
          echo "Current working directory: $(pwd)"
          echo "User: $(whoami)"
          echo "Groups: $(groups)"
          
          # Настраиваем Git для неинтерактивного режима
          git config --global credential.helper store
          git config --global user.email "deploy@copytrade.gg"
          git config --global user.name "copytrade-deploy"
          
          # Проверяем, что токен установлен
          if [ -z "${{ secrets.GPAT }}" ]; then
            echo "ERROR: GPAT secret is not set!"
            exit 1
          fi
          
          # Создаем файл с учетными данными в правильном формате
          echo "https://${{ secrets.GPAT }}:x-oauth-basic@github.com" > ~/.git-credentials
          
          if [ -d ".git" ]; then
            echo "Repository exists, pulling latest changes..."
            
            # Устанавливаем remote URL с токеном
            git remote set-url origin https://${{ secrets.GPAT }}:x-oauth-basic@github.com/TaroHarado/copytrade-nginx.git
            
            git fetch origin
            git reset --hard origin/main
          else
            echo "Cloning repository..."
            
            # Клонируем в текущую директорию
            if git clone https://${{ secrets.GPAT }}:x-oauth-basic@github.com/TaroHarado/copytrade-nginx.git .; then
              echo "Clone successful"
            else
              echo "Clone failed"
              exit 1
            fi
          fi
          
          # Проверяем существование файлов
          if [ -f "deploy-copytrade.sh" ]; then
            chmod +x deploy-copytrade.sh
            echo "deploy-copytrade.sh found and made executable"
          else
            echo "Error: deploy-copytrade.sh not found"
            ls -la
            exit 1
          fi
          
          if [ -f "init-letsencrypt-copytrade.sh" ]; then
            chmod +x init-letsencrypt-copytrade.sh
            echo "init-letsencrypt-copytrade.sh found and made executable"
          else
            echo "Warning: init-letsencrypt-copytrade.sh not found"
          fi
          
          if [ -f "switch-config.sh" ]; then
            chmod +x switch-config.sh
            echo "switch-config.sh found and made executable"
          else
            echo "Warning: switch-config.sh not found"
          fi

          # Запускаем deploy.sh
          echo "Starting deployment..."
          export GITHUB_ACTIONS=true
          export CI=true
          ./deploy-copytrade.sh


